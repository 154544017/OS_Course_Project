## 电梯调度 方案报告

>1651701
>
>
>
>魏楠
>
>
>
>注: 源代码在src文件夹下; jar包必须在命令行下执行java -jar命令执行(双击无法启动)

[TOC]

###  1. 界面设计

![UI](E:\课程资料\操作系统\UI.png)

​        整个界面分为四部分， 第一部分为左上角的外部按钮，第二部分为右上角的电梯运行模拟，第三部分为电梯内部，第四部分为电梯切换。

#### 1. 外部按钮
   - 外部按钮模拟每层楼里的电梯外部按钮，包括1楼的上行键，20楼的下行键，其他楼层的上下行键。当按钮被按下时变为橙色，电梯到来后会恢复银色。
#### 2. 电梯运行模拟

	包含两部分：滑道(Slider)及下方的Button

   - Slider通过滑块(Thumb)的位置变化模拟电梯的运动，滑轨(Track)的颜色变化表明状态:绿色表明电梯门关闭，橙色表明电梯门打开。
   - Button上的文字表明电梯现在的楼层和状态, "**↑**" 为上行, "**↓**" 为下行，"**-**" 为静止。
#### 3. 电梯内部

 	包含三部分，展示面板，功能键，选层键

   - 展示面板：由上下行指示灯(运行时相应灯为橙色)，和表明当前楼层的Button组成。
   - 功能键：由开门键，关门键，警铃键(按下会响警铃声)组成。
   - 选层键：20个按键，按下为橙色，直到到达对应楼层回复为银色。
#### 4. 电梯切换
   - 由一组单选按钮构成，选择当前展示哪一部电梯的内部。



### 2. 功能设计

#### 1. 总体算法设计

   本项目需要实现多电梯调度机制。对于多部电梯的外请求，采用外调度算法来调度合适的电梯响应该请求；对于电梯的内请求，采用内调度算法来响应电梯内部的请求队列。

   电梯运行状态转换图如下：

   ![state](E:\课程资料\操作系统\state.png)

#### 2. 调度算法设计

##### 1. 外调度算法

​	本项目采用单独的线程来处理外调度。当用户按下外部按钮后，该外请求任务被添加到队列outerTaskQueue中。外调度算法将会扫描该队列，并将队列中的任务分配给合适的电梯。

   - 外调度算法：

     1. 运动方向优先：

        - 寻找运动方向与请求方向相同的电梯，若该电梯被分配了其他外请求任务，则其他任务的请求方向也应该和当前请求的方向相同。
        - 访问符合要求电梯的当前位置，筛掉请求楼层不在该电梯运动路径上的电梯(若方向为上行则电梯应处于请求楼层下方，方向为下行则电梯应处于请求楼层上方)。
        - 在符合的电梯中寻找距离请求楼层最近的电梯，将该请求添加到此电梯的外请求任务中。

     2. 如果未找到合适的电梯，则采用静止优先的方法寻找：

        - 寻找当前状态为静止(等待)的电梯
        - 访问符合要求电梯的当前位置，寻找距离请求楼层最近的电梯，将该请求添加到此电梯的外请求任务中。

     3. 如果没有满足上述要求的电梯，则将该任务挂起，等待一会，直到符合上述要求的电梯出现。

   - 外调度流程图：

     ![外调度](E:\课程资料\操作系统\外调度.png)

   - 电梯内部对外任务的处理：电梯内部只记录了外任务的信息，处理仍是当作内任务处理。

     ​        如果此电梯的外任务记录表中不存在该任务，就将此任务信息存在外任务记录表中；然后根据该任务的请求楼层与电梯所在楼层的位置关系，添加对应的内任务到内调度队列中。

   

##### 2. 内调度算法

​	本项目为每部电梯都开始了单独的线程，内任务分为上行任务和下行任务，分别用TreeSet存储(既保证了任务的唯一性，又可以将任务自然排序)。而内调度算法在自己的电梯线程中执行。

​	在内任务被添加时，根据其请求楼层和电梯当前位置的关系，存到上行任务队列/下行任务队列中。上行任务队列中的任务按楼层升序排序，下行任务队列降序排序。保证在一趟中将同向任务全部处理完毕。

- 内调度算法

  - 若电梯当前状态为静止，则分别扫描上下行任务队列，如果任务队列中存在任务，就执行相应的move函数。
  - 若电梯当前状态为上行，则扫描上行任务队列，如果还有任务，则执行相应的move函数，否则将状态改为静止(等待)。
  - 若电梯当前状态为下行，则扫描下行任务队列，如果还有任务，则执行相应的move函数，否则将状态改为静止(等待)。

#### 3. 其他功能设计

##### 1. move函数设计

```java
//params:该内任务的目的楼层和运动方向
move(int next_floor, int state);
```

1. 如果还未到目的楼层，在运动方向上运动一层，更新电梯运行模拟和电梯内部展示界面的UI。

2. 如果移动后到达了目的楼层：

   - 在外任务记录表中查找是否存在该层，如果存在，则删除该外任务并更新外部按钮UI，将对应按钮熄灭。

   - 在内任务队列中查找是否存在该层，如果存在，则删除该内任务，并更新电梯内部UI，将对应按钮熄灭。

   - 如果内任务队列为空，则更新电梯状态为停止(等待)。

   - 更新电梯运行模拟的UI，模拟开关门(上下客)。

##### 2.开关门功能设计

``` java
//通过添加同层的上升任务来模拟开门
 public void openDoor(){
        if ((arrivedNextFloor || status == Command.REST) && !doorIsOpen) {
            upTaskSet.add(currentFloor);
        }
    }

 public void closeDoor(){
        slider.setStyle("-jfx-default-thumb: #0f9d58");
        doorIsOpen = false;
    }
```

​	在电梯门处于关闭状态且电梯处于静止(等待)状态或者停留状态时，通过给该电梯添加到达所在楼层的内任务来模拟开门。关门则通过直接改变UI来实现。

##### 3.报警键功能设计

```java
AudioClip audioClip = new AudioClip(Paths.get("src/resource/alarm.wav")
                                    .toUri().toString());
audioClip.play();
```

​	调用AudioClip来播放一段警报铃声。

   

  ### 3. 运行展示

##### 1.内调度算法

​	将内任务进行排序，尽量同一趟能处理完所有内任务

- **UI**：

  ![1557413495634](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1557413495634.png)

- 电梯内调度打印

  ![1557413662763](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1557413662763.png)

##### 2. 外调度算法优先选择运行方向相同且最近的电梯


- **UI**：

  ![1557413886830](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1557413886830.png)

- 电梯外调度打印

  ![1557413935318](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1557413935318.png)
  
  ![1557413906937](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1557413906937.png)

![1557413950435](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1557413950435.png)

##### 3. 外调度算法优先选择静止且最近的电梯

- **UI**：

  ![1557414104245](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1557414104245.png)

- 电梯外调度打印

  ![1557414125946](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1557414125946.png)

